import * as names from "@package/self/common/names"
import {concat} from "@package/self/common/util"
import {get} from "property-seek"
import {Fragment} from "@package/self/layout/fragment/Fragment"
import {Column, Table as TableContext} from ".."

{% fun allSelectedCheckbox[D] (TableContext[D]) %}

      <th>

        <input 
          type="checkbox"
          onclick={{@values.table.thead.th.onSelect}}/>
      
      </th>

{% endfun %}

{% fun headings[D](TableContext[D])(columns:Column[D][]) %}

  {% for field:Column[D] in columns %}

    {% if field.sortAs %}

      <th 
       class={{concat(@values.class.heading, 
         if(@values.sortedOn == field.name) then 
           names.ACTIVE 
         else '')}}
            onclick={{@values.table.thead.th.onclick(field.name)}}>

        {{field.heading}}

       {% if (@values.sortedOn == field.name)  %}

        {{@values.arrow}}

       {% else %}

        {{''}}

       {% endif %}
                
        </th>

       {% else %}

          <th 
            class={{concat(@values.class.heading,
              if(@values.sortedOn == field.name) then 
                names.ACTIVE 
              else '')}}
            onclick={{@values.table.thead.th.onclick(field.name)}}>

            {{field.heading}}

            {{ if (@values.sortedOn == field.name) then @values.arrow else ''}}

          </th>

       {% endif %}

    {% endfor %}

{% endfun %}

{% fun thead[D](TableContext[D])(columns:Column[D][]) %}

  <tr>

    {% if @values.options.selectable %}

      {{ <allSelectedCheckbox(@)> }}

      {{ <headings(@)(columns)> }}

    {% else %}

      {{ <headings(@)(columns)> }}

    {% endif %}

  </tr>

{% endfun %}

{% fun rowSelectCheckbox[D] (TableContext[D]) (row:D,index:Number) %}

    {% if @values.options.selectable %}

      <td>
            
        <input 
          type="checkbox"
          onclick={{@values.table.tbody.tr.onSelect(row, index, @values.data)}}/>
          
      </td>

    {% else %}

      {{''}}

    {% endif %}

{% endfun %}

{% fun cells[D](TableContext[D])(rowData:D, rowNumber:Number, columns:Column[D][]) %}

  {% if @values.options.selectable %}

    {{<rowSelectCheckbox(@)(rowData)(rowNumber)>}}

  {% else %}

    {{ '' }}
          
  {% endif %}

  {% for field:Column[D],index:Number in columns %}
        
    <td 
      wml:id={{@values.table.tbody.td.id(field.name, index, rowNumber)}}
      class={{@values.table.tbody.td.class}}
      onclick={{@values.table.tbody.td.onclick(get(field.name,rowData),field.name, rowData, rowNumber)}}>

      {% if field.fragment %}

        {{ <field.fragment(get(field.name,rowData))(field.name)(rowData)> }}

      {% else %}

        {{ get(field.name,rowData) }}

      {% endif %}

    </td>

  {% endfor %}

{% endfun %}

{% fun rows[D](TableContext[D])(data:D[],columns:Column[D][]) %}

    {% for rowData:D,index:Number in data %}

      <tr 
        class={{@values.table.tbody.tr.class}}
        onclick={{@values.table.tbody.tr.onclick(rowData,index,data)}}>

        {{ <cells(@)(rowData)(index)(columns)> }}

      </tr>

    {% endfor %}

{% endfun %}

{% fun table [D](TableContext[D]) %}

    <table 
      wml:id={{@values.id.root}}
      class={{@values.class.root}}>

      <thead 
        wml:id="head">{{ <thead(@)(@values.columns)> }}</thead>
        
      <tbody 
        wml:id="body"> {{ <rows(@)(@values.data)(@values.columns)> }}</tbody>

    </table>

{% endfun %}

{% view Table [D](TableContext[D]) %}

  <Fragment>

    {% if (@values.data.length == 0) %}

      {% if @values.fragment.empty %}

        {{ @values.fragment.empty.render() }}

      {% else %}

        {{ <table(@)> }}

      {% endif %}

    {% else %}

        {{ <table(@)> }}

    {% endif %}

  </Fragment>

{% endview %}

